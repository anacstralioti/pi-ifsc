{% extends "base.html" %}
{% load static %}

{% block title %}
Gerenciamento de Projetos - Produtiva
{% endblock %}

{% block header_right_content %}
<div class="relative flex items-center">
  {% if user.is_authenticated %}
    <!-- BOTÃO DO PERFIL -->
    <button id="perfilMenuBtn" class="group flex items-center space-x-2 focus:outline-none">
      {% if perfil and perfil.foto %}
        <img src="{{ perfil.foto.url }}" alt="Foto de Perfil"
             class="w-8 h-8 rounded-full object-cover border border-gray-300 group-hover:ring-2 group-hover:ring-indigo-500 transition">
      {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      {% endif %}
      <span class="font-medium text-gray-800 group-hover:text-indigo-600 transition">
        {{ user.first_name }}
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <!-- DROPDOWN -->
    <div id="perfilDropdown"
         class="hidden absolute right-0 mt-12 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
      <a href="{% url 'perfil' %}"
         class="block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition rounded-t-lg">
         Editar Perfil
      </a>
      <a href="{% url 'logout' %}"
         class="block px-4 py-2 text-red-600 hover:bg-red-50 hover:text-red-700 transition rounded-b-lg">
         Sair
      </a>
    </div>
  {% else %}
    <a href="{% url 'login' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
       Faça Login
    </a>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("perfilMenuBtn");
    const menu = document.getElementById("perfilDropdown");

    if (btn) {
      btn.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });

-      document.addEventListener("click", (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add("hidden");
        }
      });
    }
  });
</script>
{% endblock header_right_content %}

{% block 'body' %}
<div class="flex min-h-screen bg-gray-100 p-6">

  <!-- Barra lateral -->
  <div class="w-1/4 bg-white p-6 rounded-lg shadow-md border border-gray-200 mr-6 h-fit">
    {% if user.perfil.is_admin %}
      <a href="#" id="novoProjetoBtn" class="flex items-center justify-center w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Novo Projeto
      </a>
    {% else %}
      <div class="text-center bg-gray-50 border border-gray-200 rounded-md p-4 shadow-sm">
        <p class="text-gray-600 font-medium">Você participa de projetos ativos.</p>
        <p class="text-gray-500 text-sm mt-1">Somente administradores podem criar novos projetos.</p>
      </div>
    {% endif %}

    <!-- Modal Novo Projeto -->
    <div id="novoProjetoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-semibold mb-4">Adicionar Novo Projeto</h3>
        <form action="{% url 'projetos' %}" method="post">
          {% csrf_token %}
          <label class="block text-gray-700 font-medium">Nome do Projeto</label>
          <input type="text" name="nome_projeto" placeholder="Nome do Projeto" class="mt-1 block w-full rounded-md bg-gray-100 px-3 py-2 text-base text-gray-800 outline outline-1 outline-gray-300 placeholder:text-gray-500 focus:outline-2 focus:outline-indigo-500" required />
          <label class="block text-gray-700 font-medium">Descrição</label>
          <textarea name="descricao" placeholder="Descrição do Projeto (Opcional)" rows="4" class="mt-3 block w-full rounded-md bg-gray-100 px-3 py-2 text-base text-gray-800 outline outline-1 outline-gray-300 placeholder:text-gray-500 focus:outline-2 focus:outline-indigo-500"></textarea>

          {% if user.perfil.is_admin %}
            <div class="mb-3">
              <label class="block text-gray-700 font-medium">Participantes</label>
              <select id="participantesSelect" name="participantes" multiple>
                {% for u in users %}
                  {% if not u.perfil.is_admin %}
                    <option value="{{ u.id }}">{{ u.first_name }} ({{ u.username }})</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
          {% endif %}

          <div class="flex justify-end mt-4">
            <button type="button" id="cancelNovoProjeto" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md mr-2 hover:bg-gray-300">Cancelar</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Criar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Editar Projeto -->
  <div id="editarProjetoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <h3 class="text-lg font-semibold mb-4">Editar Projeto</h3>
      <form id="editarProjetoForm" method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="projeto_id" id="editar_projeto_id" />
        <label class="block text-gray-700">Nome do Projeto</label>
        <input type="text" name="nome_projeto" id="editar_nome_projeto" class="mt-1 block w-full rounded-md bg-gray-100 px-3 py-2" required />
        <label class="block text-gray-700 mt-3">Descrição</label>
        <textarea name="descricao" id="editar_descricao" rows="3" class="mt-1 block w-full rounded-md bg-gray-100 px-3 py-2"></textarea>
        <label class="block text-gray-700 mt-3">Participantes</label>
        <select id="editar_participantes" name="participantes" multiple class="block w-full rounded-md border border-gray-300 bg-white text-gray-800 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 py-2 px-3">
          {% for u in users %}
            {% if not u.perfil.is_admin %}
              <option value="{{ u.id }}">{{ u.first_name }} ({{ u.username }})</option>
            {% endif %}
          {% endfor %}
        </select>
        <div class="flex justify-end mt-4">
          <button type="button" id="cancelEditarProjeto" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md mr-2 hover:bg-gray-300">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="w-3/4 bg-white p-6 rounded-lg shadow-md border border-gray-200">

    {% if messages %}
      <div class="mb-4 space-y-2 w-full">
        {% for message in messages %}
          <div class="w-full text-center py-2 px-4 rounded-md {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Projetos Ativos -->
    <h2 class="text-xl font-bold mb-4 text-gray-800">Projetos Ativos</h2>
    <div class="max-h-96 overflow-y-auto">
      <ul class="space-y-4">
        {% if projetos %}
          {% for projeto in projetos %}
            <li class="flex items-center justify-between bg-gray-50 p-4 rounded-md border border-gray-200 project-item" data-project-id="{{ projeto.id }}">
              <div class="flex-1 pr-4">
                <a href="{% url 'tarefas_por_projeto' projeto.id %}" class="text-lg font-medium text-gray-800 hover:text-indigo-600 hover:underline">{{ projeto.nome_projeto }}</a>
                <p class="text-sm text-gray-500 mt-1">{{ projeto.descricao|default_if_none:"Sem descrição" }}</p>
              </div>
              <div class="flex items-center space-x-3">
                {% if user.perfil.is_admin %}
                  <button class="editar-projeto-btn p-2 text-gray-500 hover:text-indigo-600" data-id="{{ projeto.id }}" data-nome="{{ projeto.nome_projeto }}" data-descricao="{{ projeto.descricao }}" data-participantes="{{ projeto.participantes.all|join:',' }}" title="Editar Projeto">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Z" />
                    </svg>
                  </button>
                  <button class="concluir-projeto-btn p-2 text-gray-500 hover:text-green-600" data-url="{% url 'concluir_projeto' projeto.id %}" title="Concluir Projeto">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                  </button>
                  <button class="delete-project-btn p-2 text-gray-500 hover:text-red-600" data-url="{% url 'cancelar_projeto' projeto.id %}" title="Cancelar Projeto">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  </button>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        {% else %}
          <p class="text-gray-600">Nenhum projeto encontrado. Clique em "+ Novo Projeto" para começar!</p>
        {% endif %}
      </ul>
    </div>

    <!-- Projetos Concluídos -->
    <h2 class="text-xl font-bold mt-10 mb-4 text-gray-800 border-t pt-6">
      Projetos Concluídos
    </h2>
    <div class="max-h-96 overflow-y-auto">
      <ul class="space-y-4">
        {% if concluidos %}
          {% for projeto in concluidos %}
            <li class="flex items-center justify-between bg-gray-50 p-4 rounded-md border border-gray-200">
              <div>
                <span class="text-gray-500">{{ projeto.nome_projeto }}</span>
                <p class="text-sm text-gray-400">{{ projeto.descricao|default_if_none:"Sem descrição" }}</p>
              </div>
              <div class="flex items-center space-x-3">
                  <a href="{% url 'relatorio_produtividade' projeto.id %}"
                    class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 transition-all duration-200">
                    Relatório
                  </a>
                  {% if user.perfil.is_admin %}
                    <button class="restaurar-projeto-btn px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600" data-url="{% url 'restaurar_projeto_concluido' projeto.id %}">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                      </svg>
                    </button>
                    <button class="excluir-definitivo-btn px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 flex items-center space-x-2" data-url="{% url 'excluir_definitivamente' projeto.id %}">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                      </svg>
                    </button>
                  {% endif %}
              </div>
            </li>
          {% endfor %}
        {% else %}
          <p class="text-gray-500">Nenhum projeto concluido.</p>
        {% endif %}
      </ul>
    </div>

    <!-- Projetos Cancelados -->
    <h2 class="text-xl font-bold mt-10 mb-4 text-gray-800 border-t pt-6">Projetos Cancelados</h2>
    <div class="max-h-96 overflow-y-auto">
      <ul class="space-y-4">
        {% if cancelados %}
          {% for projeto in cancelados %}
            <li class="flex items-center justify-between bg-gray-50 p-4 rounded-md border border-gray-200">
              <div>
                <span class="text-gray-500 line-through">{{ projeto.nome_projeto }}</span>
                <p class="text-sm text-gray-400 line-through">{{ projeto.descricao|default_if_none:"Sem descrição" }}</p>
              </div>
              {% if user.perfil.is_admin %}
                <div class="flex items-center space-x-3">
                  <button class="restaurar-projeto-btn px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600" data-url="{% url 'restaurar_projeto' projeto.id %}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  </button>
                  <button class="excluir-definitivo-btn px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 flex items-center space-x-2" data-url="{% url 'excluir_definitivamente' projeto.id %}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                  </button>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <p class="text-gray-500">Nenhum projeto cancelado.</p>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="{% static 'js/projeto.js' %}"></script>
<script src="{% static 'js/tomselect-init.js' %}"></script>

{% endblock 'body' %}
