{% extends "base.html" %}
{% load static %}

{% block title %}Tarefas de {{ projeto.nome_projeto }}{% endblock %}

{% block header_right_content %}
<div class="relative flex items-center">
  {% if user.is_authenticated %}
    <!-- BOTÃO DO PERFIL -->
    <button id="perfilMenuBtn" class="group flex items-center space-x-2 focus:outline-none">
      {% if perfil and perfil.foto %}
        <img src="{{ perfil.foto.url }}" alt="Foto de Perfil"
             class="w-8 h-8 rounded-full object-cover border border-gray-300 group-hover:ring-2 group-hover:ring-indigo-500 transition">
      {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      {% endif %}
      <span class="font-medium text-gray-800 group-hover:text-indigo-600 transition">
        {{ user.first_name }}
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <!-- DROPDOWN -->
    <div id="perfilDropdown"
         class="hidden absolute right-0 mt-12 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
      <a href="{% url 'perfil' %}"
         class="block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition rounded-t-lg">
         Editar Perfil
      </a>
      <a href="{% url 'logout' %}"
         class="block px-4 py-2 text-red-600 hover:bg-red-50 hover:text-red-700 transition rounded-b-lg">
         Sair
      </a>
    </div>
  {% else %}
    <a href="{% url 'login' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
       Faça Login
    </a>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("perfilMenuBtn");
    const menu = document.getElementById("perfilDropdown");

    if (btn) {
      btn.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });

-      document.addEventListener("click", (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add("hidden");
        }
      });
    }
  });
</script>
{% endblock header_right_content %}

{% block 'body' %}
<div class="flex flex-col lg:flex-row min-h-screen bg-gray-100 p-4 lg:p-6 gap-4 lg:gap-6">
  <div class="w-full lg:w-1/4 bg-white p-4 lg:p-6 rounded-lg shadow-md border border-gray-200 mr-6 h-fit">
    <a
      href="#"
      id="novaTarefaBtn"
      class="flex items-center justify-center w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
    >
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      Nova Tarefa
    </a>
    <a
      href="{% url 'projetos' %}"
      class="mt-4 block text-center text-sm text-indigo-600 hover:text-indigo-800 hover:underline"
    >
      &larr; Voltar para todos os projetos
    </a>
  </div>

  <div class="w-full lg:flex-1 bg-white p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
    <h1 class="text-2xl lg:text-3xl font-bold mb-2">
      <span class="text-indigo-600">{{ projeto.nome_projeto }}</span>
    </h1>
    <p class="text-gray-600 mb-6">{{ projeto.descricao|default_if_none:"" }}</p>
<div class="flex flex-wrap items-center gap-2 lg:gap-4 mt-4 mb-6">
  <div class="relative group">

    {% if projeto.usuario.perfil.foto %}
      <img src="{{ projeto.usuario.perfil.foto.url }}" 
           class="w-10 h-10 rounded-full object-cover border-2 border-yellow-500 shadow">
    {% else %}
      <div class="w-10 h-10 rounded-full bg-yellow-300 flex items-center justify-center text-gray-700 text-sm">
        {{ projeto.usuario.first_name|slice:":1" }}{{ projeto.usuario.last_name|slice:":1" }}
      </div>
    {% endif %}

    <div class="absolute left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block
                bg-yellow-600 text-white text-xs rounded px-3 py-2 z-50 whitespace-nowrap shadow-lg">

      <p class="font-semibold">
        {{ projeto.usuario.first_name }} {{ projeto.usuario.last_name }}
        <span class="text-yellow-300 font-bold">(Administrador)</span>
      </p>

      <p class="text-gray-200">{{ projeto.usuario.email }}</p>
    </div>

  </div>

  {% for participante in projeto.participantes.all %}
    {% if participante != projeto.usuario %}
      <div class="relative group">

        {% if participante.perfil.foto %}
          <img src="{{ participante.perfil.foto.url }}" 
               class="w-10 h-10 rounded-full object-cover border-2 border-indigo-500 shadow">
        {% else %}
          <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-sm">
            {{ participante.first_name|slice:":1" }}{{ participante.last_name|slice:":1" }}
          </div>
        {% endif %}

        <div class="absolute left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block
                    bg-gray-900 text-white text-xs rounded px-3 py-2 z-50 whitespace-nowrap shadow-lg">

          <p class="font-semibold">
            {{ participante.first_name }} {{ participante.last_name }}
          </p>

          <p class="text-gray-300">{{ participante.email }}</p>
        </div>

      </div>
    {% endif %}
  {% endfor %}
</div>

    {% if messages %}
    <div class="mb-4 space-y-2 w-full">
      {% for message in messages %}
      <div
        class="w-full text-center py-2 px-4 rounded-md {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <p class="font-semibold mb-4">Tarefas encontradas: {{ tarefas|length }}</p>

    <!-- TAREFAS ATIVAS -->
    <h2 class="text-xl font-bold mb-2 text-gray-800">Tarefas Ativas</h2>
    {% if tarefas %}
    <div class="overflow-x-auto max-h-96 overflow-y-auto mb-8">
      <table class="min-w-[800px] border border-gray-200 rounded-lg shadow-sm text-center">
        <thead class="bg-gray-100 sticky top-0 z-10">
          <tr>
            <th class="px-4 py-3 border-b text-left">Nome</th>
            <th class="px-4 py-3 border-b text-left">Descrição</th>
            <th class="px-4 py-3 border-b text-left">Estimativa</th>
            <th class="px-4 py-3 border-b text-left">Categoria</th>
            <th class="px-4 py-3 border-b text-center">Editar</th>
            <th class="px-4 py-3 border-b text-center">Apontamentos</th>
            <th class="px-4 py-3 border-b text-center">Concluir</th>
            <th class="px-4 py-3 border-b text-center">Cancelar</th>
          </tr>
        </thead>
        <tbody>
          {% for tarefa in tarefas %}
          <tr
            class="hover:bg-gray-100 {% if tarefa.categoria == 'URGENTE_IMPORTANTE' %}bg-red-200 text-red-900{% elif tarefa.categoria == 'IMPORTANTE_NAO_URGENTE' %}bg-yellow-200 text-yellow-900{% elif tarefa.categoria == 'URGENTE_NAO_IMPORTANTE' %}bg-blue-200 text-blue-900{% elif tarefa.categoria == 'NAO_IMPORTANTE_NAO_URGENTE' %}bg-green-200 text-green-900{% endif %}"
          >
            <td class="px-4 py-3 text-left leading-normal">{{ tarefa.nome_tarefa }}</td>
            <td class="px-4 py-3 text-left leading-normal">{{ tarefa.descricao|default:"-" }}</td>
            <td class="px-4 py-3 text-left leading-normal">{{ tarefa.estimativa_horas|time:"H:i" }}</td>
            <td class="px-4 py-3 text-left leading-normal">{{ tarefa.get_categoria_display }}</td>
            <td class="px-4 py-3 text-left leading-normal">
              <a
                href="#"
                class="editar-tarefa inline-flex items-center justify-center px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition"
                data-id="{{ tarefa.id }}"
                data-nome="{{ tarefa.nome_tarefa }}"
                data-descricao="{{ tarefa.descricao }}"
                data-categoria="{{ tarefa.categoria }}"
                data-estimativa="{{ tarefa.estimativa_horas|time:'H:i' }}"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Z"/>
                </svg>
              </a>
            </td>
            <td class="px-4 py-2 text-center">
              <a href="{% url 'apontamentos_tarefa' tarefa.id %}"
                class="inline-flex items-center justify-center px-3 py-1 rounded-md {% if tarefa.apontamento_ativo %}bg-green-100 text-green-800 animate-pulse{% else %}bg-blue-100 text-blue-800 hover:bg-blue-200{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
                {% if tarefa.apontamento_ativo %}Em Andamento{% else %}Ver/Lançar{% endif %}
              </a>
            </td>
            <td class="px-4 py-2 text-center">
              <button
                class="concluir-tarefa-btn flex justify-center items-center mx-auto p-2 text-gray-500 hover:text-green-600 transition"
                data-url="{% url 'concluir_tarefa' tarefa.id %}"
                title="Concluir Tarefa"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/>
                </svg>
              </button>
            </td>
            <td class="px-4 py-2 text-center">
              <button
                class="cancelar-tarefa-btn flex justify-center items-center mx-auto p-2 text-gray-500 hover:text-red-600 transition"
                data-url="{% url 'cancelar_tarefa' tarefa.id %}"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-600">Nenhuma tarefa ativa encontrada.</p>
    {% endif %}

    <!-- TAREFAS CONCLUÍDAS -->
    <h2 class="text-xl font-bold mt-10 mb-4 text-gray-800 border-t pt-6">
      Tarefas Concluídas
    </h2>

    {% if tarefas_concluidas %}
    <div class="overflow-x-auto max-h-96 overflow-y-auto mb-8 lg:mb-10">
      <table class="w-full border border-gray-200 rounded-lg shadow-sm text-center">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-3 border-b text-left">Nome</th>
            <th class="px-4 py-3 border-b text-left">Descrição</th>
            <th class="px-4 py-3 border-b text-center">Restaurar</th>
            <th class="px-4 py-3 border-b text-center">Excluir</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for tarefa in tarefas_concluidas %}
          <tr class="hover:bg-gray-50 even:bg-gray-50 align-middle">
            <td class="px-4 py-3 text-gray-600 text-left font-medium leading-normal">
              {{ tarefa.nome_tarefa }}
            </td>
            <td class="px-4 py-3 text-gray-400 text-left leading-normal">
              {{ tarefa.descricao|default_if_none:"Sem descrição" }}
            </td>
            <td class="px-4 py-3 text-center align-middle">
              <button
                class="restaurar-tarefa-btn inline-flex justify-center items-center px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition"
                data-url="{% url 'restaurar_tarefa' tarefa.id %}"
                title="Restaurar tarefa"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
              </button>
            </td>
            <td class="px-4 py-3 text-center align-middle">
              <button
                class="excluir-tarefa-btn inline-flex justify-center items-center px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition"
                data-url="{% url 'excluir_tarefa_definitivo' tarefa.id %}"
                title="Excluir tarefa definitivamente"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500 mb-8 lg:mb-10">Nenhuma tarefa concluída.</p>
    {% endif %}

    <!-- TAREFAS CANCELADAS -->
    <h2 class="text-xl font-bold mb-4 text-gray-800 border-t pt-6">
      Tarefas Canceladas
    </h2>

    {% if tarefas_canceladas %}
    <div class="overflow-x-auto max-h-96 overflow-y-auto mb-8 lg:mb-10">
      <table class="min-w-[600px] border border-gray-200 rounded-lg shadow-sm text-center">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-3 border-b text-left">Nome</th>
            <th class="px-4 py-3 border-b text-left">Descrição</th>
            <th class="px-4 py-3 border-b text-center">Restaurar</th>
            <th class="px-4 py-3 border-b text-center">Excluir</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for tarefa in tarefas_canceladas %}
          <tr class="hover:bg-gray-50 even:bg-gray-50 align-middle">
            <td class="px-4 py-3 text-gray-500 line-through text-left font-medium leading-normal">
              {{ tarefa.nome_tarefa }}
            </td>
            <td class="px-4 py-3 text-gray-400 text-left leading-normal line-through">
              {{ tarefa.descricao|default_if_none:"Sem descrição" }}
            </td>
            <td class="px-4 py-3 text-center align-middle">
              <button
                class="restaurar-tarefa-btn inline-flex justify-center items-center px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition"
                data-url="{% url 'restaurar_tarefa' tarefa.id %}"
                title="Restaurar tarefa"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
              </button>
            </td>
            <td class="px-4 py-3 text-center align-middle">
              <button
                class="excluir-tarefa-btn inline-flex justify-center items-center px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition"
                data-url="{% url 'excluir_tarefa_definitivo' tarefa.id %}"
                title="Excluir permanentemente"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                  stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500 mb-8 lg:mb-10">Nenhuma tarefa cancelada.</p>
    {% endif %}

  </div>
</div>

<!-- MODAL -->
<div id="novoTarefaModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white w-full max-w-md lg:max-w-lg p-4 lg:p-6 rounded-lg shadow-lg relative animate-fadeInScale max-h-[90vh] overflow-y-auto">
    <h3 id="modalTitle" class="text-lg font-semibold mb-4">Adicionar Tarefa</h3>
    <form id="tarefaForm" method="post" action="{% url 'tarefas_por_projeto' projeto.id %}">
      {% csrf_token %}
      <input type="hidden" name="tarefa_id" id="tarefa_id">
      <label class="block text-gray-700 font-medium">Nome da Tarefa</label>
      <input type="text" name="nome_tarefa" id="nome_tarefa" required class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
      <label class="block text-gray-700 font-medium mt-3">Descrição</label>
      <textarea name="descricao" id="descricao" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500"></textarea>
      <label class="block text-gray-700 font-medium mt-3">Estimativa</label>
      <input type="time" name="estimativa_horas" id="estimativa_horas" required lang="pt-BR" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
      <label class="block text-gray-700 font-medium mt-3">Categoria</label>
      <select name="categoria" id="categoria" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
        <option value="">Selecione...</option>
        <option value="URGENTE_IMPORTANTE">Importante e Urgente</option>
        <option value="IMPORTANTE_NAO_URGENTE">Importante e Não Urgente</option>
        <option value="URGENTE_NAO_IMPORTANTE">Urgente e Não Importante</option>
        <option value="NAO_IMPORTANTE_NAO_URGENTE">Não Importante e Não Urgente</option>
      </select>
      <div class="flex justify-end mt-6">
        <button type="button" id="cancelNovaTarefa" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Cancelar</button>
        <button type="submit" id="modalSubmitBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Criar Tarefa</button>
      </div>
    </form>
  </div>
</div>

<style>
  input[type="time"]::-webkit-datetime-edit-ampm-field { display: none; }
  input[type="time"] { -webkit-text-fill-color: #000; color-scheme: light; }
  @keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  .animate-fadeInScale { animation: fadeInScale 0.25s ease-in-out; }
</style>

<script src="{% static 'js/tarefas.js' %}"></script>
{% endblock %}
