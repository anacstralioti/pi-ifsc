{% extends "base.html" %}
{% load static %}

{% block title %}Relatório de Produtividade - {{ projeto.nome_projeto }}{% endblock %}

{% block header_right_content %}
<div class="relative flex items-center">
  {% if user.is_authenticated %}
    <!-- BOTÃO DO PERFIL -->
    <button id="perfilMenuBtn" class="group flex items-center space-x-2 focus:outline-none">
      {% if perfil and perfil.foto %}
        <img src="{{ perfil.foto.url }}" alt="Foto de Perfil"
             class="w-8 h-8 rounded-full object-cover border border-gray-300 group-hover:ring-2 group-hover:ring-indigo-500 transition">
      {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      {% endif %}
      <span class="font-medium text-gray-800 group-hover:text-indigo-600 transition">
        {{ user.first_name }}
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <!-- DROPDOWN -->
    <div id="perfilDropdown"
         class="hidden absolute right-0 mt-12 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
      <a href="{% url 'perfil' %}"
         class="block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition rounded-t-lg">
         Editar Perfil
      </a>
      <a href="{% url 'logout' %}"
         class="block px-4 py-2 text-red-600 hover:bg-red-50 hover:text-red-700 transition rounded-b-lg">
         Sair
      </a>
    </div>
  {% else %}
    <a href="{% url 'login' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
       Faça Login
    </a>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("perfilMenuBtn");
    const menu = document.getElementById("perfilDropdown");

    if (btn) {
      btn.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });

-      document.addEventListener("click", (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add("hidden");
        }
      });
    }
  });
</script>
{% endblock header_right_content %}

{% block 'body' %}
<div class="min-h-screen bg-gray-100 py-8 px-6">
  <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-md p-6 border border-gray-200">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">
      Relatório de Produtividade - {{ projeto.nome_projeto }}
    </h1>

    <!-- Produtividade geral -->
    <div class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Produtividade Geral</h2>
      <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
        <div class="h-4 bg-indigo-600" style="width: {{ produtividade_percentual }}%; transition: width 0.5s ease;"></div>
      </div>
      <p class="text-gray-600 text-sm mt-2">
        {{ produtividade_percentual }}% do tempo dentro do estimado
      </p>
    </div>

    <!-- Tabela -->
    <table class="w-full border-collapse border border-gray-300 mb-6">
      <thead class="bg-gray-50">
        <tr>
          <th class="border border-gray-300 px-4 py-2 text-left">Tarefa</th>
          <th class="border border-gray-300 px-4 py-2 text-center">Status</th>
          <th class="border border-gray-300 px-4 py-2 text-center">Tempo Estimado (h)</th>
          <th class="border border-gray-300 px-4 py-2 text-center">Tempo Gasto (h)</th>
          <th class="border border-gray-300 px-4 py-2 text-center">Diferença</th>
        </tr>
      </thead>
      <tbody>
        {% for tarefa in tarefas %}
          <tr class="hover:bg-gray-50">
            <td class="border border-gray-300 px-4 py-2">{{ tarefa.nome }}</td>
            <td class="border border-gray-300 px-4 py-2 text-center">
              {% if tarefa.status == "Cancelada" %}
                <span class="text-red-500 font-semibold">Cancelada</span>
              {% elif tarefa.status == "Não executada" %}
                <span class="text-yellow-500 font-semibold">Não executada</span>
              {% else %}
                <span class="text-green-600 font-semibold">Concluída</span>
              {% endif %}
            </td>
            <td class="border border-gray-300 px-4 py-2 text-center">{{ tarefa.estimado }}</td>
            <td class="border border-gray-300 px-4 py-2 text-center">{{ tarefa.gasto }}</td>
            <td class="border border-gray-300 px-4 py-2 text-center">
              {% if tarefa.diferenca == "-" %}
                <span class="text-gray-400">-</span>
              {% elif tarefa.diferenca > 0 %}
                <span class="text-red-600 font-semibold">+{{ tarefa.diferenca }}</span>
              {% elif tarefa.diferenca < 0 %}
                <span class="text-green-600 font-semibold">{{ tarefa.diferenca }}</span>
              {% else %}
                <span class="text-gray-500">0</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center text-gray-500 py-4">Nenhuma tarefa registrada.</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot class="bg-gray-100 font-semibold">
        <tr>
          <td class="border border-gray-300 px-4 py-2 text-right">Totais (somente concluídas executadas):</td>
          <td class="border border-gray-300 px-4 py-2 text-center">—</td>
          <td class="border border-gray-300 px-4 py-2 text-center">{{ total_estimado }}</td>
          <td class="border border-gray-300 px-4 py-2 text-center">{{ total_gasto }}</td>
          <td class="border border-gray-300 px-4 py-2 text-center">{{ diferenca_total }}</td>
        </tr>
      </tfoot>
    </table>

    <!-- Gráfico -->
    <canvas id="graficoProdutividade" height="100"></canvas>

    <div class="mt-6 text-right">
      <a href="{% url 'projetos' %}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
        Voltar
      </a>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('graficoProdutividade');

  const labels = [
    {% for tarefa in tarefas %}
      {% if tarefa.status == "Concluída" and tarefa.gasto > 0 %}
        '{{ tarefa.nome|escapejs }}',
      {% endif %}
    {% endfor %}
  ];

  const estimado = [
    {% for tarefa in tarefas %}
      {% if tarefa.status == "Concluída" and tarefa.gasto > 0 %}
        {{ tarefa.estimado }},
      {% endif %}
    {% endfor %}
  ];

  const gasto = [
    {% for tarefa in tarefas %}
      {% if tarefa.status == "Concluída" and tarefa.gasto > 0 %}
        {{ tarefa.gasto }},
      {% endif %}
    {% endfor %}
  ];

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Tempo Estimado (h)',
          data: estimado,
          backgroundColor: 'rgba(99, 102, 241, 0.7)',
        },
        {
          label: 'Tempo Gasto (h)',
          data: gasto,
          backgroundColor: 'rgba(239, 68, 68, 0.7)',
        },
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
      },
      scales: {
        x: {
          title: { display: true, text: 'Tarefas' },
          ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 },
        },
        y: {
          beginAtZero: true,
          max: 10, // ✅ limita o gráfico a 10 horas
          title: { display: true, text: 'Horas' },
        },
      },
    },
  });
</script>
{% endblock %}
