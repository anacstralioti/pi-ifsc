{% extends "base.html" %}
{% load static %}

{% block title %}Relatório de Produtividade - {{ projeto.nome_projeto }}{% endblock %}

{% block header_right_content %}
<div class="relative flex items-center">
  {% if user.is_authenticated %}
    <!-- BOTÃO DO PERFIL -->
    <button id="perfilMenuBtn" class="group flex items-center space-x-2 focus:outline-none">
      {% if perfil and perfil.foto %}
        <img src="{{ perfil.foto.url }}" alt="Foto de Perfil"
             class="w-8 h-8 rounded-full object-cover border border-gray-300 group-hover:ring-2 group-hover:ring-indigo-500 transition">
      {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      {% endif %}
      <span class="font-medium text-gray-800 group-hover:text-indigo-600 transition">
        {{ user.first_name }}
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-500 group-hover:text-indigo-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <!-- DROPDOWN -->
    <div id="perfilDropdown"
         class="hidden absolute right-0 mt-12 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
      <a href="{% url 'perfil' %}"
         class="block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition rounded-t-lg">
         Editar Perfil
      </a>
      <a href="{% url 'logout' %}"
         class="block px-4 py-2 text-red-600 hover:bg-red-50 hover:text-red-700 transition rounded-b-lg">
         Sair
      </a>
    </div>
  {% else %}
    <a href="{% url 'login' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
       Faça Login
    </a>
  {% endif %}
</div>

{% endblock header_right_content %}

{% block 'body' %}
<div class="min-h-screen bg-gray-100 py-8 px-6">
  <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-md p-6 border border-gray-200">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">
      Relatório de Produtividade - {{ projeto.nome_projeto }}
    </h1>

    <!-- Tabela -->
    <table class="w-full border-collapse border border-gray-300 mb-6">
      <thead class="bg-gray-50">
        <tr>
          <th class="border border-gray-300 px-4 py-2 text-left">Tarefa</th>
          <th class="border border-gray-300 px-4 py-2 text-center">Status</th>
          <th class="border border-gray-300 px-4 py-2 text-center">Tempo Estimado</th>
          <th class="border border-gray-300 px-4 py-2 text-center">Tempo Gasto</th>
        </tr>
      </thead>
      <tbody>
        {% for tarefa in tarefas %}
          <tr class="hover:bg-gray-50">
            <td class="border border-gray-300 px-4 py-2">{{ tarefa.nome }}</td>
            <td class="border border-gray-300 px-4 py-2 text-center">
              {% if tarefa.status == "Cancelada" %}
                <span class="text-red-500 font-semibold">Cancelada</span>
              {% elif tarefa.status == "Não executada" %}
                <span class="text-yellow-500 font-semibold">Não executada</span>
              {% else %}
                <span class="text-green-600 font-semibold">Concluída</span>
              {% endif %}
            </td>
            <td class="border border-gray-300 px-4 py-2 text-center">{{ tarefa.estimado }}</td>
            <td class="border border-gray-300 px-4 py-2 text-center">{{ tarefa.gasto }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center text-gray-500 py-4">Nenhuma tarefa registrada.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

<!-- GRÁFICO -->
<h4 class="mt-4">Gráfico de Tempo Estimado vs Tempo Gasto</h4>
<canvas id="graficoProdutividade"></canvas>
    <div class="mt-6 text-right">
      <a href="{% url 'projetos' %}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
        Voltar
      </a>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

  const ctx = document.getElementById('graficoProdutividade');

  /* ================================
        GERAR LABELS
     ================================ */
  const labels = [
    {% for tarefa in tarefas %}
        {% if tarefa.status == "Concluída" %}
            '{{ tarefa.nome|escapejs }}',
        {% endif %}
    {% endfor %}
  ];

  /* ================================
        TEMPO ESTIMADO EM MINUTOS
     ================================ */
  const estimado = [
    {% for tarefa in tarefas %}
        {% if tarefa.status == "Concluída" %}
            {{ tarefa.estimado_num|default:0 }},
        {% endif %}
    {% endfor %}
  ];

  /* ================================
        TEMPO GASTO EM MINUTOS
     ================================ */
  const gasto = [
    {% for tarefa in tarefas %}
        {% if tarefa.status == "Concluída" %}
            {{ tarefa.gasto_num|default:0 }},
        {% endif %}
    {% endfor %}
  ];

  /* ================================
        INICIALIZA CHART
     ================================ */
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: "Estimado (min)",
          data: estimado,
          backgroundColor: 'rgba(99, 102, 241, 0.7)',
        },
        {
          label: "Gasto (min)",
          data: gasto,
          backgroundColor: 'rgba(239, 68, 68, 0.7)'
        }
      ]
    },

    options: {
      responsive: true,
      plugins: { 
        legend: { position: 'bottom' }
      },

      scales: {
        x: {
          title: {
            display: true,
            text: 'Nome das Tarefas',
            font: { size: 14, weight: 'bold' },
          },

          ticks: {
            autoSkip: false,
            maxRotation: 0,
            minRotation: 0,
            font: { size: 11 },
            
            /* QUEBRA NOMES MUITO LONGOS EM 3 PALAVRAS POR LINHA */
            callback: function(value) {
              const label = this.getLabelForValue(value);
              const words = label.split(" ");
              const chunkSize = 3;
              let lines = [];

              for (let i = 0; i < words.length; i += chunkSize) {
                lines.push(words.slice(i, i + chunkSize).join(" "));
              }

              return lines;
            }
          }
        },

        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Minutos',
            font: { size: 14, weight: 'bold' },
          }
        }
      }
    }
  });

</script>

{% endblock %}
